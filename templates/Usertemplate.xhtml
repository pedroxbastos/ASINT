<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html
        PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">

<head>

    <style>
        div.background {
            background-color: #00FFFF;
        }
    </style>
    <title>Administrator browser</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
</head>
<body>


<div class="background" id="authenticate">{{LoginId}}</div>
<div class="background" id="locationspot">(Location will be here)</div>
<div class="background" id="serverresp">(Server response)</div>
<h2>Links</h2>
<input type="text" name="" size="20" id="Messagetosend" />
<input type="submit" value="Send"  id="Sendbutton"/>
<p>
<button type="button" id="Recvbutton">Receive Messages</button>
<div id="fieldMsg">(Messages will be here)</div>


<script>
 //<![CDATA[

     function sendtokencode(fn, context) { 
        var result;
        var url1 = window.location.search;
        postData = {"code": url1};
        return function() { 
            $.ajax({
                type: "POST",
                url: "http://127.0.0.1:5000/User/getToken",
                contentType: "application/json; charset=utf-8",
                data: JSON.stringify(postData),
                dataType: 'json',
                success: function (response) {
                    console.log(response);
                }
                })
                fn=null;
        }
        return result;
    };

    // Usage
    var canOnlyFireOnce = sendtokencode(function() {
        console.log('Fired!');
    });
    canOnlyFireOnce(); // "Fired!"

    var periodiclocal = setInterval(geoLocal,5000);
    var x = document.getElementById("locationspot");
    function geoLocal() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(showPosition);
            navigator.geolocation.getCurrentPosition(postLocation);
        } else {
        x.innerHTML = "Geolocation is not supported by this browser.";
        }
    } 
    function showPosition(position) {
        x.innerHTML = "Latitude: " + position.coords.latitude + 
        "<br>Longitude: " + position.coords.longitude; 
    }
    function postLocation(position){
        var lat = position.coords.latitude;
        var lon = position.coords.longitude;
        var result = document.getElementById("serverresp");
        var authname = document.getElementById("authenticate");
        postData = {"name": authname.innerHTML, "location":[lat,lon]};

        $.ajax({
            type: "POST",
            url: "http://127.0.0.1:5000/API/User/PostmyLocation",
            contentType: "application/json; charset=utf-8",
            data:JSON.stringify(postData),
            dataType: 'json',
            success: function (response) {
                $("#serverresp").text(response[0]["result"]);
            }
        })
    }
    $( document ).ready(function() {
        $( "#Sendbutton" ).click(function( event ) {
            var authname = document.getElementById("authenticate").innerHTML;
            console.log("click");
            $.ajax({
                type: "POST",
                url: "http://127.0.0.1:5000/API/User/SendBroadMsg/"+authname,
                dataType: "json",
                contentType: "application/json",
                data: '{"name":"' + authname + '","Message":"' + $("#Messagetosend").val() + '"}',
                success: function (data) {
                    console.log(data);
                }
            });
        });
    });

    $( document ).ready(function() {
        $( "#Recvbutton" ).click(function( event ) {
            var authname = document.getElementById("authenticate").innerHTML;
            console.log("click");
            $.ajax({
                type: "GET",
                url: "http://127.0.0.1:5000/API/User/RecvMsg/"+authname,
                dataType: "json",
                contentType: "application/json",
                success: function (data) {
                    console.log(data);
                        s = "<ol>";
                        //for (var i = 0, len = data.length; i < len; i++) {
                        //    s += "<li>";
                        //    s += data[i];
                        //    s += "</li>";
                        //}
                        s="Messages Received:"
                        for (var key in data) {
                            if (data.hasOwnProperty(key)) {
                                console.log(key + " -> " + data[key]);
                                for (var i = 0, len = data[key].length; i < len; i++) {
                                s += "<li>";
                                s += data[key][i]
                                s += "</li>";   
                                }                            
                        }
                        }
                        s += "</ol>";
                        $("#fieldMsg").html(s);
                }
        });
    });
    });

 //]]>
</script>
</body>
</html>